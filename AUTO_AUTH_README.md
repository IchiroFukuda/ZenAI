# 自動匿名認証の実装

このプロジェクトでは、ユーザーが何もアクションする必要がない自動匿名認証システムを実装しています。初回アクセス時に自動で匿名ユーザーとしてログインし、アカウント作成やログインをしても**ゲスト（匿名）時のデータは引き継がれません**。

**重要**: ユーザーには匿名認証の存在を認識させません。見た目は未ログイン状態と同じで、ログアウトボタンも表示されません。

---

## 主な仕様

- ゲスト（匿名）利用時はSupabase上に匿名ユーザーアカウントのみ作成されます
- ゲスト時に作成した思考ログや気づき等のデータは、**アカウント作成・ログイン後には引き継がれません**
- ログイン・サインアップ後は**新しいアカウントで新規スタート**となります
- UIやFAQで「ゲストデータは引き継がれません」と明記するのが親切です（実装は任意）

---

## 実装されたコンポーネント

### `useAutoAuth` フック
```typescript
const { user, loading, isAnonymous, signOut } = useAutoAuth();
```

**機能:**
- 自動匿名認証の初期化
- 認証状態の監視
- ログアウト処理

---

## 認証フロー

### 1. 初回アクセス
```
ユーザーがページにアクセス
↓
自動的に匿名認証を実行
↓
匿名ユーザーとしてログイン完了
↓
アプリケーションを即座に利用可能
```

### 2. メールアドレスログイン・サインアップ
```
ゲストユーザーがメールアドレスでログイン/サインアップ
↓
新しい認証ユーザーとしてログイン
↓
**ゲスト時のデータは引き継がれません**
↓
新しいアカウントで新規スタート
```

### 3. ログアウト
```
ログアウトボタンをクリック
↓
セッション終了
↓
次回アクセス時に再度匿名認証
```

---

## データベース操作

- 匿名ユーザーのデータは、その匿名ユーザーのセッション中のみ有効です
- ログイン・サインアップ後は新しいuser_idでデータが保存されます
- ゲスト時のデータは引き継がれません

---

## セキュリティ

- 匿名ユーザーのデータは他のユーザーから完全に分離
- RLSポリシーにより、ユーザーIDに基づいてアクセス制御
- Supabaseの標準認証機能を使用

---

## 使用方法

### 開発者向け
```typescript
// コンポーネントで使用
import { useAutoAuth } from "@/hooks/useAutoAuth";

function MyComponent() {
  const { user, loading, isAnonymous, signOut } = useAutoAuth();
  
  if (loading) return <div>読み込み中...</div>;
  
  return (
    <div>
      {isAnonymous ? "ゲストユーザー" : user.email}
      <button onClick={signOut}>ログアウト</button>
    </div>
  );
}
```

### ユーザー向け
1. **初回アクセス**: 何もせずにアプリケーションを使用開始（見た目は未ログイン状態）
2. **ログイン/サインアップ**: メールアドレスでログイン・サインアップすると新しいアカウントで利用開始
3. **ゲスト時のデータは引き継がれません**

---

## エラーハンドリング

- 認証エラーが発生してもアプリケーションは動作
- エラーログをコンソールに出力
- ユーザー体験を損なわない設計

---

## パフォーマンス

- 匿名認証は高速（通常1秒以内）
- UIブロッキングを最小限に抑制
- データベースのインデックスを活用した効率的なクエリ

---

## 今後の改善点

- ゲストデータの一時保存やエクスポート機能の追加
- ゲストデータのインポート機能
- UIでの注意書き表示

---

## トラブルシューティング

- 匿名認証が動作しない場合はSupabaseの設定や環境変数を確認
- データが引き継がれないのは仕様です

--- 
