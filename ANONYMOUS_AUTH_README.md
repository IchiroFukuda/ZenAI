# 匿名ユーザー認証の実装

このプロジェクトでは、Supabaseの匿名ユーザー認証機能を実装しています。ユーザーはメールアドレスやパスワードを入力することなく、すぐにアプリケーションを使用できます。

## 機能

### 1. 匿名認証ボタン
- **ログインページ**: 「匿名で始める」ボタンで匿名ログイン
- **ナビゲーションバー**: 未ログイン時に「匿名で始める」ボタンを表示

### 2. ユーザー状態の表示
- **匿名ユーザー**: 緑のドットと「匿名ユーザー」表示
- **認証ユーザー**: 青のドットとメールアドレス表示

### 3. データの永続化
- 匿名ユーザーも通常のユーザーと同様にデータベースにデータを保存
- 思考ログ、気づき、セッション情報が永続化される

## 実装されたコンポーネント

### `useAnonymousAuth` フック
```typescript
const { user, loading, signInAnonymously, signOut } = useAnonymousAuth();
```

### `AnonymousAuthButton` コンポーネント
```typescript
<AnonymousAuthButton 
  className="custom-class"
  onSuccess={() => console.log('匿名ログイン成功')}
  onError={(error) => console.error('エラー:', error)}
/>
```

### `UserStatus` コンポーネント
```typescript
<UserStatus className="custom-class" />
```

## データベース設定

### RLSポリシー
以下のテーブルでRow Level Securityが有効化されています：
- `thoughts` - 思考セッション
- `logs` - 思考ログ
- `insights` - AIの気づき

### 匿名ユーザーの権限
匿名ユーザーは以下の操作が可能です：
- 自分のデータの作成・読み取り・更新・削除
- 他のユーザーのデータへのアクセスは不可

## 使用方法

### 1. 匿名ログイン
1. ログインページまたはナビゲーションバーの「匿名で始める」ボタンをクリック
2. 自動的に匿名ユーザーとしてログイン
3. アプリケーションの全機能が利用可能

### 2. 匿名ログアウト
1. ナビゲーションバーの「匿名ログアウト」ボタンをクリック
2. セッションが終了し、ローカルストレージのデータのみ残る

### 3. 通常認証への移行
匿名ユーザーから通常の認証ユーザーへの移行は、現在の実装では手動で行う必要があります：
1. 匿名ログアウト
2. 通常のログイン（メール/パスワードまたはGoogle）
3. 新しいユーザーとしてデータを再作成

## セキュリティ考慮事項

### 1. データの分離
- 匿名ユーザーのデータは他のユーザーから完全に分離
- RLSポリシーにより、ユーザーIDに基づいてアクセス制御

### 2. セッション管理
- 匿名ユーザーのセッションはブラウザセッションに依存
- ブラウザを閉じるとセッションが終了

### 3. データの永続性
- 匿名ユーザーのデータはデータベースに永続化
- セッション終了後もデータは保持される

## 今後の改善点

### 1. 匿名から認証ユーザーへの移行
- 匿名ユーザーのデータを通常の認証ユーザーに移行する機能
- データの統合と重複の回避

### 2. セッション管理の改善
- より長期間のセッション保持
- デバイス間でのセッション同期

### 3. データエクスポート
- 匿名ユーザーのデータエクスポート機能
- バックアップと復元機能

## トラブルシューティング

### 匿名認証が失敗する場合
1. Supabaseプロジェクトで匿名認証が有効化されているか確認
2. 環境変数（`NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`）が正しく設定されているか確認
3. ブラウザのコンソールでエラーメッセージを確認

### データが表示されない場合
1. RLSポリシーが正しく設定されているか確認
2. データベーススキーマが最新か確認
3. ユーザーIDが正しく設定されているか確認 
